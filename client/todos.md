# 客户端 (Rust) 开发计划

## 1. 项目设置

- [ ] 初始化Rust项目 (`cargo new`)。
- [ ] 添加依赖到 `Cargo.toml`:
    - `tokio`: 异步运行时。
    - `tungstenite` 或 `tokio-tungstenite`: WebSocket客户端实现。
    - `serde` 和 `serde_json`: 用于序列化/反序列化与服务端通信的数据。
    - `uuid`: 用于生成和管理客户端的唯一标识符。
    - `directories`: 用于方便地找到 `%APPDATA%` 等系统目录。
    - `windows-service` (可选，用于后台服务化) 或 `winapi` 用于隐藏控制台窗口。

## 2. 核心功能

- [ ] **启动与初始化**:
    - [ ] 检查当前可执行文件是否位于 `%APPDATA%` 下的特定文件夹中。
    - [ ] 如果不在，则将自身复制到目标文件夹，并从新位置重新启动，然后退出当前进程。
    - [ ] **UUID管理**:
        - [ ] 检查 `%APPDATA%` 目录下是否存在UUID配置文件 (例如 `client_id.txt`)。
        - [ ] 如果不存在，则生成一个新的UUID v4，并将其保存到该文件中。
        - [ ] 如果存在，则读取该UUID作为本客户端的标识。
    - [ ] 在Windows环境下，将程序作为无窗口的后台进程运行。

- [ ] **WebSocket连接**:
    - [ ] 从配置文件或硬编码中读取服务端的地址和端口。
    - [ ] 启动一个异步任务，尝试连接到服务端的WebSocket。
    - [ ] **自动重连**: 如果连接失败或意外断开，实现一个带有退避策略（例如，每隔5秒、10秒、30秒...）的自动重连机制。
    - [ ] 连接成功后，立即向服务端发送 `register` 事件，并附上自己的UUID。

## 3. 命令执行模块

- [ ] **上下文管理**:
    - [ ] **共享上下文模式**:
        - [ ] 实现一个长期运行的 `powershell.exe` 或 `cmd.exe` 子进程。
        - [ ] 使用其 `stdin`, `stdout`, 和 `stderr` 进行交互。
        - [ ] 为了避免阻塞和正确捕获输出，需要精细地处理IO流。这可能需要为每个流（stdout, stderr）创建一个独立的异步任务来读取。
        - [ ] 命令执行后，需要一个可靠的方式来判断命令是否已经执行完毕并返回了完整的输出（例如，通过在命令后追加一个特殊的、唯一的结束标记）。
    - [ ] **新上下文模式**:
        - [ ] 对于每条命令，都创建一个新的 `powershell.exe -Command "..."` 或 `cmd.exe /c "..."` 进程。
        - [ ] 捕获其输出并返回。
        - [ ] 这种模式更简单，但无法维持状态（例如 `cd` 命令的效果不会保留）。

- [ ] **WebSocket消息处理**:
    - [ ] 监听来自服务端的 `run_command` 事件。
    - [ ] 解析消息，获取 `command` 和 `use_shared_context` 参数。
    - [ ] 根据参数选择相应的命令执行模式。
    - [ ] 执行命令后，将捕获到的输出 (stdout 和 stderr) 通过WebSocket发送回服务端的 `command_output` 事件。

## 4. 文件系统操作

- [ ] **监听 `do_file_operation` 事件**:
    - [ ] 根据收到的 `operation` 和 `path` 参数，执行相应的文件操作。
- [ ] **实现操作**:
    - [ ] `list_dir`: 列出指定目录下的文件和文件夹，返回一个列表。
    - [ ] `read_file`: 读取指定文件的内容 (需要考虑文件大小和编码)。
    - [ ] `write_file`: 将接收到的数据写入指定文件。
    - [ ] `delete_file`: 删除指定文件。
    - [ ] `delete_dir`: 删除指定目录 (以及其内容)。
- [ ] 将操作结果通过WebSocket发送回服务端的 `file_operation_result` 事件。
- [ ] **安全性**: 严格检查和清理传入的 `path` 参数，防止路径遍历等攻击 (例如，禁止使用 `..` 或绝对路径)。

## 5. 健壮性与部署

- [ ] **错误处理**:
    - [ ] 为所有IO操作、网络通信和命令执行添加详尽的错误处理和日志记录。
    - [ ] 将错误信息也一并返回给服务端，方便调试。
- [ ] **编译与打包**:
    - [ ] 配置 `Cargo.toml` 以在发布模式 (`--release`)下进行优化和裁剪，减小可执行文件的大小。
    - [ ] 编写一个简单的构建脚本，方便自动化编译。